<html>
	<head>
		<title>3D Object Viewer</title>
		<link rel="stylesheet" type="text/css" href="3DObjectViewer.css">
	</head>
	<body>
		<div class="content">
			<div id="container"></div>
			<div id="container2">
				<span id="densityLabel"></span>:&nbsp;<span id="densityValue"></span>&nbsp;gm/cc&nbsp;<input type="submit" class="buttonChanger" onclick="moreDensity(true);" value="+"/>&nbsp;<input type="submit" class="buttonChanger" onclick="moreDensity(false);" value="-"/><br />
				<span id="weightLabel"></span>:&nbsp;<span id="weightValue"></span>&nbsp;gm<br />
				<span id="volumeLabel"></span>:&nbsp;<span id="volumeValue"></span>&nbsp;cm3<br />
				<span id="sizeLabel"></span>:&nbsp;<span id="widthValue"></span>x<span id="depthValue"></span>x<span id="heightValue"></span>&nbsp;cm<br />
			</div>
			<div class="container3">
				<div class="leftitem">
					<input type="file" id="modelOBJ" onChange="runViewer();" disabled>
				</div>
				<div class="rightitem" id="about"></div>
			</div>
		</div>

		 <script src="3DObjectViewer.js"></script>
		 <script>

			// THE BROWSER LANGUAGE VARIABLE
			var userLanguage = window.navigator.userLanguage || window.navigator.language;

			var container, camera, scene, renderer, controls, light, vol, mesh, height, heightFinal, width, widthFinal, depth, depthFinal;

			var density = parseFloat("1.05");

			if (userLanguage.substring(0,2)=="es")
				{
				document.getElementById("densityLabel").innerHTML = "Densidad";
				document.getElementById("weightLabel").innerHTML = "Peso";
				document.getElementById("volumeLabel").innerHTML = "Volumen";
				document.getElementById("sizeLabel").innerHTML = "Medidas";
				document.getElementById("about").innerHTML = "Por LRusso.com - Todos los derechos reservados.";
				}
				else
				{
				document.getElementById("densityLabel").innerHTML = "Density";
				document.getElementById("weightLabel").innerHTML = "Weight";
				document.getElementById("volumeLabel").innerHTML = "Volume";
				document.getElementById("sizeLabel").innerHTML = "Size";
				document.getElementById("about").innerHTML = "By LRusso.com - All rights reserved.";
				}

			function init(file)
				{
				container = document.getElementById("container");
				container.innerHTML= "";

				camera = new THREE.PerspectiveCamera(37.8,window.innerWidth/window.innerHeight,1,100000);

				camera.position.z=300;
				camera.position.y=-500;
				camera.position.x=-500;
				camera.up=new THREE.Vector3(0,0,1);

				scene = new THREE.Scene();
				scene.background = new THREE.Color(0x303030);

				var filename = file.name;
				var extension = filename.split(".").pop().toLowerCase();
				var reader = new FileReader();

				if (extension=="stl")
					{
					reader.readAsArrayBuffer(file);
					}
				else if (extension=="3ds")
					{
					reader.readAsArrayBuffer(file);
					}
				else if (extension=="obj")
					{
					reader.readAsText(file);
					}
					else
					{
					document.getElementById("container2").style.display="none";
					if (userLanguage.substring(0,2)=="es")
						{
						alert("ERROR: Por favor verifique que el modelo se encuentre en formato STL, OBJ o 3DS.");
						}
						else
						{
						alert("ERROR: Please check that the model is a STL, OBJ or 3DS model.");
						}
					}

				reader.addEventListener("load", function (event)
					{
					try
						{
						var contents = event.target.result;
						if (extension=="obj")
							{
							var object = new THREE.OBJLoader().parse(contents);
							var sceneConverter = new THREE.Scene();
							sceneConverter.add(object);
							var exporter = new THREE.STLExporter();
							contents = exporter.parse(sceneConverter);
							}
						else if (extension=="3ds")
							{
							var object = new THREE.TDSLoader().parse(contents);
							var sceneConverter = new THREE.Scene();
							sceneConverter.add(object);
							var exporter = new THREE.STLExporter();
							contents = exporter.parse(sceneConverter);
							}

						var geometry = new THREE.STLLoader().parse(contents);
						geometry.computeFaceNormals();
						geometry.computeVertexNormals();
						geometry.center();

						var material = new THREE.MeshPhongMaterial({color:0xffffff});
						mesh = new THREE.Mesh(geometry, material);

						// CALCULATING THE VOLUME
						vol = 0;

						mesh.traverse(function (child)
							{
							if (child instanceof THREE.Mesh)
								{
								var positions = child.geometry.getAttribute("position").array;
								for(var i=0;i<positions.length; i+=9)
									{
									var t1 = {};
									t1.x = positions[i+0];
									t1.y = positions[i+1];
									t1.z = positions[i+2];

									var t2 = {};
									t2.x = positions[i+3];
									t2.y = positions[i+4];
									t2.z = positions[i+5];

									var t3 = {};
									t3.x = positions[i+6];
									t3.y = positions[i+7];
									t3.z = positions[i+8];

									vol += signedVolumeOfTriangle(t1,t2,t3);
									}
								}
							});

						var box = new THREE.Box3().setFromObject(mesh);

						height = box.max.z - box.min.z;
						width = box.max.x - box.min.x;
						depth = box.max.y - box.min.y;

						heightFinal = height / 10;heightFinal = heightFinal.toFixed(2);
						widthFinal = width / 10;widthFinal = widthFinal.toFixed(2);
						depthFinal = depth / 10;depthFinal = depthFinal.toFixed(2);
						var volumeFinal = vol / 1000;volumeFinal = volumeFinal.toFixed(2);
						var weightFinal = volumeFinal * density;weightFinal = weightFinal.toFixed(2);

						document.getElementById("container2").style.display="block";
						document.getElementById("densityValue").innerHTML = density;
						document.getElementById("weightValue").innerHTML = weightFinal;
						document.getElementById("volumeValue").innerHTML = volumeFinal;
						document.getElementById("widthValue").innerHTML = widthFinal; 
						document.getElementById("depthValue").innerHTML = depthFinal;
						document.getElementById("heightValue").innerHTML = heightFinal;

						var distance;

						if (height>width)
							{
							distance = height * 2;
							}
							else
							{
							distance = width * 2;
							}

						camera.position.set(0, -distance, 0);

						var x = distance + 200;
						var y = distance + 200;
						var division_x=Math.floor(x/10);
						var division_y=Math.floor(y/10);

						var wirePlane=new THREE.Mesh(new THREE.PlaneGeometry(x,y,division_x,division_y),new THREE.MeshPhongMaterial({emissive:0x707070,color:0x000000,wireframe:true,wireframeLinewidth:1}));
						wirePlane.receiveShadow=true;
						wirePlane.position.z = box.min.z - 0.1;
						scene.add(wirePlane);

						// AN ALTERNATIVE FOR MOVING THE OBJECT USING THE MOUSE WITHIN THE RENDERER
						// controls = new THREE.OrbitControls(camera, renderer.domElement);
						controls = new THREE.OrbitControls(camera);
						controls.update();

						scene.add(mesh);
						}
						catch(err)
						{
						document.getElementById("container2").style.display="none";
						if (userLanguage.substring(0,2)=="es")
							{
							alert("ERROR: Por favor verifique que el modelo se encuentre en formato STL, OBJ o 3DS.");
							}
							else
							{
							alert("ERROR: Please check that the model is a STL, OBJ or 3DS model.");
							}	
						}
					}, false);

				light = new THREE.HemisphereLight(0xE8E8E8,0x000000,1);
				light.position.set(0,0,0);
				scene.add(light);

				renderer = new THREE.WebGLRenderer({antialias:true});
				renderer.setSize(window.innerWidth,window.innerHeight);
				container.appendChild(renderer.domElement);

				requestAnimationFrame(animate);

				window.addEventListener("resize", onWindowResize, false );
				}

			function animate()
				{
				requestAnimationFrame(animate);
				light.position.copy(camera.getWorldPosition());
				renderer.render(scene,camera);
				}

			function onWindowResize()
				{
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
				}

			function moreDensity(a)
				{
				if (a==true)
					{
					var result = parseFloat(density) + parseFloat("0.05");
					if (result<=2)
						{
						density = result;
						}
					}
					else
					{
					var result = parseFloat(density) - parseFloat("0.05");
					if (result>0)
						{
						density = result;
						}
					}

				density = density.toFixed(2);

				var heightFinal = height / 10;heightFinal = heightFinal.toFixed(2);
				var widthFinal = width / 10;widthFinal = widthFinal.toFixed(2);
				var depthFinal = depth / 10;depthFinal = depthFinal.toFixed(2);
				var volumeFinal = vol / 1000;volumeFinal = volumeFinal.toFixed(2);
				var weightFinal = volumeFinal * density;weightFinal = weightFinal.toFixed(2);

				document.getElementById("densityValue").innerHTML = density;
				document.getElementById("weightValue").innerHTML = weightFinal;
				document.getElementById("volumeValue").innerHTML = volumeFinal;
				document.getElementById("widthValue").innerHTML = widthFinal; 
				document.getElementById("depthValue").innerHTML = depthFinal;
				document.getElementById("heightValue").innerHTML = heightFinal;
				}

			function runViewer()
				{
				var fileInput = document.getElementById("modelOBJ");
				if (fileInput.files[0]!=null)
					{
					init(fileInput.files[0]);
					fileInput.value = null;
					}
				}

			window.onload = function()
				{
				document.getElementById("modelOBJ").disabled = false;
				document.getElementById("modelOBJ").value = null;
				}
		</script>
	</body>
</html>